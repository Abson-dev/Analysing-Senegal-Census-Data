---
title: "Tabulation of Covariates and Outcomes for the Senegal census"
author: "Habibou Ibrahim"
date: '`r format (Sys.Date(), "%d %B %Y")`'
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
---

```{r setup, include = TRUE, warning=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
# library(officedown)
# library(officer)

# fp <- fp_par(
#   text.align = "center", 
#   padding.bottom = 20, padding.top = 120, 
#   border.bottom = fp_border())

#ft <- fp_text(shading.color='#EFEFEF', bold = F)
```

# Table of content

<!---BLOCK_TOC--->

\newpage


```{r, include = TRUE, warning=FALSE, echo = FALSE}
# Clear the current workspace by removing all objects.
# This is useful to start with a clean slate and avoid potential conflicts or unexpected behavior.
rm(list=ls())
```

## Importing library
```{r Package needed, results = "hide", include = TRUE, warning=FALSE, echo = FALSE}


## Importing library
### List of required packages
required_packages <- c("tidyverse","janitor" ,"readr","dplyr","haven","sf",
                       "flextable","sp", "factoextra", "FactoMineR","gtsummary", "sjPlot")

# Check if packages are installed
missing_packages <- setdiff(required_packages, installed.packages()[,"Package"])

### Install missing packages
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

### Load all packages
lapply(required_packages, library, character.only = TRUE)

```

```{r, include = TRUE, warning=FALSE, echo = FALSE}
# We set the theme to compact to ensure table fit the landscape page
# This theme will apply to all the other tables in this Rmd
set_gtsummary_theme(theme_gtsummary_compact())
```


## Importing the datasets an checking for duplicated row

### Importing the shapefile data

```{r, results='hide', include = TRUE, warning=FALSE, echo = FALSE}
# Read shapefile data for 2002 and 2013
sp_rgph_2002 <- sf::read_sf(paste0(here::here(),"/output/output_data/EAs_2002_new.shp"))
# Mutating the 'sp_rgph_2002' dataset to create a new 'id_dr' column based on conditions

sp_rgph_2013 <- sf::read_sf(paste0(here::here(),"/output/output_data/EAs_2013.shp"))

# Display the first 10 rows of the 2002 and 2013 shapefiles
head(sp_rgph_2002, 10L)
head(sp_rgph_2013, 10L)
```

### Importing the census datasets 

#### The household datasets 

**For the 2002 census data**
```{r, results='hide', include = TRUE, warning=FALSE, echo = FALSE}

# Read and check for duplicated rows in the "menage_2002" dataset
menage_2002 <- haven::read_sav(paste0(here::here(),"/output/output_data/menage_2002.sav"))
menage_2002 %>% janitor::get_dupes()
menage_2002 %>% janitor::get_dupes(ID_MENAGE)

```


**For the 2013 census dataset**

```{r, include = FALSE, warning=FALSE, echo = FALSE}

# Read and check for duplicated rows in the "menage_2013" dataset
menage_2013 <- haven::read_sav(paste0(here::here(),"/output/output_data/menage_2013.sav"))
menage_2013 %>% janitor::get_dupes() 
menage_2013 %>% janitor::get_dupes(ID_MENAGE)
```


#### The individuals datasets


**For the 2002 census data**
```{r, results='hide', include = TRUE, warning=FALSE, echo = FALSE}
# Read and check for duplicated rows in the "individus_2002" dataset
individus_2002 <- haven::read_sav(paste0(here::here(),"/output/output_data/individus_2002.sav"))
individus_2002 %>% janitor::get_dupes() 

```


**For the 2013 census dataset**

```{r, include = FALSE, warning=FALSE, echo = FALSE}

# Read and check for duplicated rows in the "individus_2013" dataset
individus_2013 <- haven::read_sav(paste0(here::here(),"/output/output_data/individus_2013.sav"))
individus_2013 %>% janitor::get_dupes() 

```


# Study Variables

## Socio-demographic variables

### Sex/gender

```{r, results='hold', include = TRUE, warning=FALSE, echo = FALSE}

gender_var = c("homme","femme","hh_size")
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,homme,femme,hh_size) %>% 
  
  plyr::rbind.fill(
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
        # Selecting relevant variables
      select(RGPH, homme,femme,hh_size)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    type = c(gender_var~"continuous"),
    label = list(
      homme ~ "Hommes",
      femme ~ "Femmes",
      hh_size ~ "Taille du ménage"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Composition des ménages") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 
```




### Age
```{r, include = TRUE, warning=FALSE, echo = FALSE}
#For babies under one year old, write “0” years. For people aged 98 and over, the instruction was to write 98 for age.

age_var = c("nbr_babies","nbr_under_14","nbr_young_people","nbr_adult", "nbr_elder_adult", "nbr_senior")

menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,nbr_babies,nbr_under_14,nbr_young_people,nbr_adult, nbr_elder_adult, nbr_senior) %>% 
  
  plyr::rbind.fill(
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
       # Selecting relevant variables
      select(RGPH,nbr_babies,nbr_under_14,nbr_young_people,nbr_adult, nbr_elder_adult, nbr_senior)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column

    type = c(age_var~"continuous"),
    
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Composition des ménages par age") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```



### Marital Status

```{r, include = TRUE, warning=FALSE, echo = FALSE}

mat_status_var = c("Monogame","Polygame","Celibataire","Veuf","Divorce")

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,Monogame,Polygame,Celibataire,Veuf,Divorce) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,Monogame,Polygame,Celibataire,Veuf,Divorce)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column

    type = c(mat_status_var~"continuous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "situation matrimoniale") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```

### Fertility


```{r, include = TRUE, warning=FALSE, echo = FALSE}
#Changer les labels
fertility_var = c("fertility")

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,fertility) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,fertility)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column

    type = c(fertility_var~"continuous"),
    label = list(
      fertility ~ "Fertilité"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Fertilité") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```

### Educational level

```{r, include = TRUE, warning=FALSE, echo = FALSE}

educ_var = c("Aucun","Primaire","Moyen","Secondaire","Superieur")

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,Aucun,Primaire,Moyen,Secondaire,Superieur) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,Aucun,Primaire,Moyen,Secondaire,Superieur)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    label = list(Aucun ~ "Aucun",
      Primaire ~ "Primaire",
      Moyen ~ "Moyen",
      Secondaire ~ "Sécondaire",
      Superieur ~ "Supérieur"),
    type = c(educ_var~"continuous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Niveau d'instruction") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```


### Literacy level

```{r, include = TRUE, warning=FALSE, echo = FALSE}
#For the RGPH 2002 dataset
literacy_var = c("Literacy_French","Literacy_Arabic","Literacy_Wolof","Literacy_Pulaar","Literacy_Sereer","Literacy_Mandingo","Literacy_Diola","Literacy_Soninke")



#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,Literacy_French,Literacy_Arabic,Literacy_Wolof,Literacy_Pulaar,Literacy_Sereer,Literacy_Mandingo,Literacy_Diola,Literacy_Soninke) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,Literacy_French,Literacy_Arabic,Literacy_Wolof,Literacy_Pulaar,Literacy_Sereer,Literacy_Mandingo,Literacy_Diola,Literacy_Soninke)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    
    label = list(Literacy_French ~ "Français",
      Literacy_Arabic ~ "Arabe",
      Literacy_Wolof ~ "Wolof",
      Literacy_Pulaar ~ "Pulaar",
      Literacy_Sereer ~ "Sereer",
      Literacy_Mandingo ~ "Mandingo",
      Literacy_Diola ~ "Diola",
      Literacy_Soninke ~ "Sononké"
      ),
    
    type = c(literacy_var~"continuous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Alphabétisation dans le ménage") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```
### Migration variable

```{r, include = TRUE, warning=FALSE, echo = FALSE}

mig_var = c("resident_pres","resident_abs","resident_vis")


#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,resident_pres,resident_abs,resident_vis) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,resident_pres,resident_abs,resident_vis)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    
    label = list(resident_pres ~ "Présent",
      resident_abs ~ "Absent",
      resident_vis ~ "Visiteur"
      ),
    
    type = c(mig_var~"continuous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Résidence dans le ménage") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 



```

### Maternal death variable

```{r, include = TRUE, warning=FALSE, echo = FALSE}

deces_mat_var = c("deces_mat_oui","deces_mat_non","deces_mat_nsp")

# Pas collecter and 2013
#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,deces_mat_oui,deces_mat_non,deces_mat_nsp) %>% 
  

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
   # by = RGPH,  # Group by "RGPH" column

    type = c(deces_mat_var~"continuous"),
    
    label = list(deces_mat_oui ~ "Oui",
      deces_mat_non ~ "Non",
      deces_mat_nsp ~ "NSP"
      ),
    
    statistic = list(
                     all_categorical() ~ "{n} ({p}%)",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Déces maternelle dans le ménage") %>%
  #add_overall() %>%
  add_n()
  # Add difference statistics to the table
  #add_difference() %>% 


```
## Socio-economic variables


### Employed variable

```{r, include = TRUE, warning=FALSE, echo = FALSE}

occup_var=c("occup_independant","occup_employeur","occup_salarie","occup_apprenti","occup_aideFamilial","occup_autre")   


#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,occup_independant,occup_employeur,occup_salarie,occup_apprenti,occup_aideFamilial,occup_autre) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,occup_independant,occup_employeur,occup_salarie,occup_apprenti,occup_aideFamilial,occup_autre)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    
    label = list(occup_independant ~ "Indépendant",
      occup_employeur ~ "Employeur",
      occup_salarie ~ "Salarié",
      occup_apprenti ~ "Apprenti",
      occup_aideFamilial ~ "Aide familial",
      occup_autre ~ "Autre"
      ),
    
    type = c(occup_var~"continuous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Occupation des membres du ménage") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 



```

### Occupational status variable

```{r , include = TRUE, warning=FALSE, echo = FALSE}

sit_occup_var=c("sit_occup_occup","sit_occup_chomeur","sit_occup_foyer","sit_occup_etudiant","sit_occup_rentier","sit_occup_retraite","sit_occup_autre")  


#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,sit_occup_occup,sit_occup_chomeur,sit_occup_foyer,sit_occup_etudiant,sit_occup_rentier,sit_occup_retraite,sit_occup_autre) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,sit_occup_occup,sit_occup_chomeur,sit_occup_foyer,sit_occup_etudiant,sit_occup_rentier,sit_occup_retraite,sit_occup_autre)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column

    type = c(sit_occup_var~"continuous"),
    
    label = list(sit_occup_occup ~ "Occupé",
      sit_occup_chomeur ~ "Chomeur",
      sit_occup_foyer ~ "Foyer",
      sit_occup_etudiant ~ "Étudiant",
      sit_occup_rentier ~ "Rentier",
      sit_occup_retraite ~ "Retraité",
      sit_occup_autre ~ "Autre"
      ),
    
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Situation dans l'occupation principale des membres du ménage") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```

### Income variable


```{r, include = TRUE, warning=FALSE, echo = FALSE}

income_var = c("I_repas_saute","I_soins_medicaux")

# Il faut revoir les labels dans cette region

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,I_repas_saute,I_soins_medicaux) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,I_repas_saute,I_soins_medicaux)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    
    label = list(
      I_repas_saute ~ "Repas sauté",
      I_soins_medicaux ~ "Soins médicaux"
      ),
    
    type = c(income_var~"continuous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%,{n}/{N})",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Sauté") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 


```

## Household variables

### Capital goods variable

```{r, include = TRUE, warning=FALSE, echo = FALSE}
#For the RGPH 2002 dataset
#OK
# 1. Radio, 2. Television, 3. Video/VCD/DVD, 4. Refrigerator/freezer, 5. Telephone, 6. Improved fireplace, 7. Air conditioner, 8. Sewing machine, 9. Water heater, 10. Stove

#For the RGPH 2013 dataset



```

### Access to basic equipment

#### For the RGPH 2002 dataset 
```{r, include = TRUE, warning=FALSE, echo = FALSE}
#For the RGPH 2002 dataset
#OK
# 1. Main mode of household waste disposal, 2. Main mode of waste water disposal, 3. Main mode of lighting, 4. Main fuel for cooking
#For the RGPH 2013 dataset

equipment_var_cat <- c("repas_saute","evacut_eaux_usees","terrain_bat","nature_sol","nature_toit","nature_mur","combustible_cuisine","eclairage","approv_eau","type_aisance","stat_occupation","type_log")


equipment_var_dicho <- c("soins_medicaux","terrain_bat","appareil_photo","moulin","ordinateur","photocopieuse","telephone_tele","chaise_bache","materiel_musique","machine_coudre","refriger_congelat","mobylette_bicycl","voiture_cam","tracteur","animaux_traite","caleche_char","houe_charrue","pirogue","caleche_charette","bicyclette","mobylette","voiture","machine_coudre","climatisateur","foyer_ameli","rechaud_cuis","telephone","refri_conge","video","televiseur","radio")

equipment_var_num <- c("piece_occup")

#,""

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(soins_medicaux,repas_saute,evacut_eaux_usees,terrain_bat,appareil_photo,moulin,ordinateur,photocopieuse,telephone_tele,chaise_bache,materiel_musique,machine_coudre,refriger_congelat,mobylette_bicycl,voiture_cam,tracteur,animaux_traite,caleche_char,houe_charrue,pirogue,caleche_charette,bicyclette,mobylette,voiture,machine_coudre,climatisateur,foyer_ameli,rechaud_cuis,telephone,refri_conge,video,televiseur,radio,nature_sol,nature_toit,nature_mur,combustible_cuisine,eclairage,approv_eau,type_aisance,stat_occupation,piece_occup,type_log) %>% 
  
  labelled::unlabelled() %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    #by = RGPH,  # Group by "RGPH" column
    
    # label = list(
    #   I_repas_saute ~ "Repas sauté",
    #   I_soins_medicaux ~ "Soins médicaux"
    #   ),
    
    type = c(equipment_var_cat~"categorical",
             equipment_var_num~"continuous",
             equipment_var_dicho~"dichotomous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%)",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Access aux equipements for the RGPH 2002") %>%
  #add_overall() %>%
  add_n()#%>% 
  # Add difference statistics to the table
  #add_difference() 

```


#### For the RGPH 2013 dataset 
```{r, include = TRUE, warning=FALSE, echo = FALSE}
#For the RGPH 2013 dataset
#OK
# 1. Main mode of household waste disposal, 2. Main mode of waste water disposal, 3. Main mode of lighting, 4. Main fuel for cooking
#For the RGPH 2013 dataset

equipment_var_cat <- c("evacut_eaux_usees","terrain_bat","nature_sol","nature_toit","nature_mur","combustible_cuisine","eclairage","approv_eau","type_aisance","stat_occupation","type_log","terrain_bat")


equipment_var_dicho <- c("soins_medicaux","appareil_photo","moulin","ordinateur","photocopieuse","telephone_tele","chaise_bache","materiel_musique","machine_coudre","refriger_congelat","mobylette_bicycl","voiture_cam","tracteur","animaux_traite","caleche_char","houe_charrue","pirogue","caleche_charette","bicyclette","mobylette","voiture","machine_coudre","climatisateur","foyer_ameli","rechaud_cuis","telephone","refri_conge","video","televiseur","radio","repas_saute","terrain_bat")

equipment_var_num <- c("piece_occup")


#For the RGPH 2013 dataset 
menage_2013 %>% 
      
# Selecting relevant variables
select(soins_medicaux,repas_saute,evacut_eaux_usees,terrain_bat,appareil_photo,moulin,ordinateur,photocopieuse,telephone_tele,chaise_bache,materiel_musique,machine_coudre,refriger_congelat,mobylette_bicycl,voiture_cam,tracteur,animaux_traite,caleche_char,houe_charrue,pirogue,caleche_charette,bicyclette,mobylette,voiture,machine_coudre,climatisateur,foyer_ameli,rechaud_cuis,telephone,refri_conge,video,televiseur,radio,nature_sol,nature_toit,nature_mur,combustible_cuisine,eclairage,approv_eau,type_aisance,stat_occupation,piece_occup,type_log) %>% 
  
  mutate(

    soins_medicaux = labelled::remove_labels(soins_medicaux) %>% structure(label=Hmisc::label(menage_2013$soins_medicaux)),
    
    repas_saute = labelled::remove_labels(repas_saute) %>% structure(label=Hmisc::label(menage_2013$repas_saute)),
    
    terrain_bat = labelled::remove_labels(terrain_bat) %>% structure(label=Hmisc::label(menage_2013$terrain_bat)),
    
    appareil_photo = labelled::remove_labels(appareil_photo) %>% structure(label=Hmisc::label(menage_2013$appareil_photo)),
    
    moulin = labelled::remove_labels(moulin) %>% structure(label=Hmisc::label(menage_2013$moulin)),
    
    ordinateur = labelled::remove_labels(ordinateur) %>% structure(label=Hmisc::label(menage_2013$ordinateur)),
    
    photocopieuse = labelled::remove_labels(photocopieuse) %>% structure(label=Hmisc::label(menage_2013$photocopieuse)),
    
    telephone_tele = labelled::remove_labels(telephone_tele) %>% structure(label=Hmisc::label(menage_2013$telephone_tele)),
    
    chaise_bache = labelled::remove_labels(chaise_bache) %>% structure(label=Hmisc::label(menage_2013$chaise_bache)),
    
    materiel_musique = labelled::remove_labels(materiel_musique) %>% structure(label=Hmisc::label(menage_2013$materiel_musique)),
    
    machine_coudre = labelled::remove_labels(machine_coudre) %>% structure(label=Hmisc::label(menage_2013$machine_coudre)),
    
    refriger_congelat = labelled::remove_labels(refriger_congelat) %>% structure(label=Hmisc::label(menage_2013$refriger_congelat)),

    mobylette_bicycl = labelled::remove_labels(mobylette_bicycl) %>% structure(label=Hmisc::label(menage_2013$mobylette_bicycl)),
    
    voiture_cam = labelled::remove_labels(voiture_cam) %>% structure(label=Hmisc::label(menage_2013$voiture_cam)),
    
    tracteur = labelled::remove_labels(tracteur) %>% structure(label=Hmisc::label(menage_2013$tracteur)),
    
    animaux_traite = labelled::remove_labels(animaux_traite) %>% structure(label=Hmisc::label(menage_2013$animaux_traite)),
    
    caleche_char = labelled::remove_labels(caleche_char) %>% structure(label=Hmisc::label(menage_2013$caleche_char)),
    
    houe_charrue = labelled::remove_labels(houe_charrue) %>% structure(label=Hmisc::label(menage_2013$houe_charrue)),
    
    pirogue = labelled::remove_labels(pirogue) %>% structure(label=Hmisc::label(menage_2013$pirogue)),
    
    caleche_charette = labelled::remove_labels(caleche_charette) %>% structure(label=Hmisc::label(menage_2013$caleche_charette)),

    bicyclette = labelled::remove_labels(bicyclette) %>% structure(label=Hmisc::label(menage_2013$bicyclette)),
    
    mobylette = labelled::remove_labels(mobylette) %>% structure(label=Hmisc::label(menage_2013$mobylette)),
    
    voiture = labelled::remove_labels(voiture) %>% structure(label=Hmisc::label(menage_2013$voiture)),
    
    machine_coudre = labelled::remove_labels(machine_coudre) %>% structure(label=Hmisc::label(menage_2013$machine_coudre)),

    climatisateur = labelled::remove_labels(climatisateur) %>% structure(label=Hmisc::label(menage_2013$climatisateur)),
    
    foyer_ameli = labelled::remove_labels(foyer_ameli) %>% structure(label=Hmisc::label(menage_2013$foyer_ameli)),
    
    rechaud_cuis = labelled::remove_labels(rechaud_cuis) %>% structure(label=Hmisc::label(menage_2013$rechaud_cuis)),
    
    telephone = labelled::remove_labels(telephone) %>% structure(label=Hmisc::label(menage_2013$telephone)),

    refri_conge = labelled::remove_labels(refri_conge) %>% structure(label=Hmisc::label(menage_2013$refri_conge)),
    
    video = labelled::remove_labels(video) %>% structure(label=Hmisc::label(menage_2013$video)),
    
    televiseur = labelled::remove_labels(televiseur) %>% structure(label=Hmisc::label(menage_2013$televiseur)),
    
    radio = labelled::remove_labels(radio) %>% structure(label=Hmisc::label(menage_2013$radio))

  ) %>%
    labelled::unlabelled() %>% 
# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(

    
       type = c(equipment_var_cat~"categorical",
                equipment_var_num~"continuous",
                 equipment_var_dicho~"dichotomous"
                ),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%)",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Access aux equipements for RGPH 2013") #%>%
  #add_overall() #%>%
  #add_n()%>% 
  # Add difference statistics to the table
  #add_difference() 

```


### Household size

```{r, include = TRUE, warning=FALSE, echo = FALSE}
#For the RGPH 2002 dataset
#OK
#For the RGPH 2013 dataset
```

### Head of household

```{r, include = TRUE, warning=FALSE, echo = FALSE}
cm_var=c("niveau_instruction_cm","sexe_cm","age_cm")

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,niveau_instruction_cm,sexe_cm,age_cm) %>%
  
  mutate(sexe_cm = as.factor(ifelse(sexe_cm ==2, 0, 1)) %>% 
           structure(label = Hmisc::label(menage_2002$sexe_cm))) %>% 

  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,niveau_instruction_cm,sexe_cm,age_cm) %>%
      
      mutate(sexe_cm = as.factor(ifelse(sexe_cm ==2, 0, 1)) %>% 
               structure(label = Hmisc::label(menage_2013$sexe_cm))))%>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    label = list(sexe_cm ~ "Sexe (Masculin = 1, Féminin = 0)",
      age_cm ~ "Age (en année)",
      niveau_instruction_cm ~ "Nbr d'années d'éducation"),
    type = c(c("age_cm","niveau_instruction_cm")~"continuous",
             c("sexe_cm")~"dichotomous"),
    statistic = list(
                     all_categorical() ~ "{n} ({p}%)",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Charactéristiques du CM") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```

### Household composition

```{r , include = TRUE, warning=FALSE, echo = FALSE}


liencm_var=c("liencm_cm","liencm_epous","liencm_enf","liencm_parent","liencm_frere","liencm_petit_fils","liencm_sans_lien")

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,liencm_cm,liencm_epous,liencm_enf,liencm_parent,liencm_frere,liencm_petit_fils,liencm_sans_lien) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,liencm_cm,liencm_epous,liencm_enf,liencm_parent,liencm_frere,liencm_petit_fils,liencm_sans_lien)) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    
    label = list(liencm_cm ~ "CM",
      liencm_epous ~ "Épouse",
      liencm_enf ~ "Enfant",
      liencm_parent ~ "Parent/Grand parent",
      liencm_frere ~ "Frére/soeur",
      liencm_petit_fils ~ "Pétit fils/fille",
      liencm_sans_lien ~ "Sans lien"),
    
    type = c(liencm_var~"continuous"),
    
    statistic = list(
                     all_categorical() ~ "{n} ({p}%)",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(0,0),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "Lien avec le CM") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 

```



# Multivariate calculation for poverty indices (MPI)



```{r, echo=FALSE, warning=FALSE, include=FALSE}

mpi_var=c("cooking_fuel_dim","sanitation_dim","drinking_water_dim","electricity_dim","housing_dim","assets_dim","school_attendance_dim","years_schooling_dim")

#For the RGPH 2002 dataset
menage_2002 %>% 
  
  # Selecting relevant variables
  select(RGPH,cooking_fuel_dim,sanitation_dim,drinking_water_dim,electricity_dim,housing_dim,assets_dim,school_attendance_dim,years_schooling_dim,deces_under_five_dim) %>% 
  
  plyr::rbind.fill(
    
    #For the RGPH 2013 dataset 
    menage_2013 %>% 
      
      # Selecting relevant variables
      select(RGPH,cooking_fuel_dim,sanitation_dim,drinking_water_dim,electricity_dim,housing_dim,assets_dim,school_attendance_dim,years_schooling_dim
             #, deces_under_five_dim
             )) %>% 

# Generate a summary table using "tbl_summary" for the specified columns
  tbl_summary(
    by = RGPH,  # Group by "RGPH" column
    
    label = list(
      
      school_attendance_dim ~ "Education: School Attendance",
      deces_under_five_dim ~ "Health: Number of under five mortality"),
    
    type = c(mpi_var~"dichotomous"),
    
    statistic = list(
                     all_categorical() ~ "{n} ({p}%)",
                     all_continuous() ~ "{mean} ({sd})"
                     ),
    missing_text = "(Missing)",
    digits = everything() ~ c(2,2),
    #missing = "no"
  ) %>% 

  # Modify the table header to provide a descriptive label
  modify_header(label ~ "MPI Dimension") %>%
  add_overall() %>%
  add_n()%>% 
  # Add difference statistics to the table
  add_difference() 
```


## Standard of Living dimension

**Data source**: 

* *For the Sanitation*: [link](https://www.who.int/data/gho/data/indicators/indicator-details/GHO/population-using-improved-sanitation-facilities-(-))

* *For water*:
[link](https://data.unicef.org/topic/water-and-sanitation/drinking-water/)
 

*Additionnal cleaning*


## Health dimension


# Building the population graph


```{r , include = TRUE, warning=FALSE, echo = FALSE}

# Creating a summary of demographic data for the year 2002
dataPop_graph_2002 <- individus_2002 %>% 
    # Grouping by sex
    group_by(QB04) %>% 
    # Summarizing various counts based on age (QB06 column)
      summarise(
        n=n(), # number of individuals by household
        nbrAge_0_14 = sum(QB06 <= 14, na.rm = TRUE),  # Count of people aged less than 14
        nbrAge_15_19 = sum(QB06 >= 15 & QB06 <= 19, na.rm = TRUE),  # Count of individuals between 15 and 19
        nbrAge_20_24 = sum(QB06 >= 20 & QB06 <= 24, na.rm = TRUE),  # Count of individuals aged 20-24
        nbrAge_25_29 = sum(QB06 >= 25 & QB06 <= 29, na.rm = TRUE),  # Count of individuals aged 25-29
        nbrAge_30_34 = sum(QB06 >= 30 & QB06 <= 34, na.rm = TRUE),  # Count of individuals aged 30-34
        nbrAge_35_39 = sum(QB06 >= 35 & QB06 <= 39, na.rm = TRUE),  # Count of individuals aged 35-39 
        nbrAge_40_44 = sum(QB06 >= 40 & QB06 <= 44, na.rm = TRUE),  # Count of individuals aged 40-44
        nbrAge_45_49 = sum(QB06 >= 45 & QB06 <= 49, na.rm = TRUE),  # Count of individuals aged 45-49
        nbrAge_50_54 = sum(QB06 >= 50 & QB06 <= 54, na.rm = TRUE),  # Count of individuals aged 50-54
        nbrAge_55_59 = sum(QB06 >= 55 & QB06 <= 59, na.rm = TRUE),  # Count of individuals aged 55-59
        nbrAge_60_64 = sum(QB06 >= 60 & QB06 <= 64, na.rm = TRUE),  # Count of individuals aged 60-64
        nbrAge_65_69 = sum(QB06 >= 65 & QB06 <= 69, na.rm = TRUE),  # Count of individuals aged 65-69
        nbrAge_70_74 = sum(QB06 >= 70 & QB06 <= 74, na.rm = TRUE),  # Count of individuals aged 70-74
        nbrAge_75_79 = sum(QB06 >= 75 & QB06 <= 79, na.rm = TRUE),  # Count of individuals aged 75-79
        nbrAge_80_over = sum(QB06 >= 80, na.rm = TRUE)  # Count of individuals aged more than 80
) %>% 
  ungroup() %>% 
  pivot_longer(cols = nbrAge_0_14:nbrAge_80_over, names_to = "Age_group", values_to = "count")

# Creating a summary of demographic data for the year 2013
dataPop_graph_2013 <- individus_2013 %>% 
    # Grouping by sex
    group_by(B06) %>% 
    # Summarizing various counts based on age (B08 column)
      summarise(
        n=n(), # number of individuals by household
        nbrAge_0_14 = sum(B08 <= 14, na.rm = TRUE),  # Count of people aged less than 14
        nbrAge_15_19 = sum(B08 >= 15 & B08 <= 19, na.rm = TRUE),  # Count of individuals between 15 and 19
        nbrAge_20_24 = sum(B08 >= 20 & B08 <= 24, na.rm = TRUE),  # Count of individuals aged 20-24
        nbrAge_25_29 = sum(B08 >= 25 & B08 <= 29, na.rm = TRUE),  # Count of individuals aged 25-29
        nbrAge_30_34 = sum(B08 >= 30 & B08 <= 34, na.rm = TRUE),  # Count of individuals aged 30-34
        nbrAge_35_39 = sum(B08 >= 35 & B08 <= 39, na.rm = TRUE),  # Count of individuals aged 35-39 
        nbrAge_40_44 = sum(B08 >= 40 & B08 <= 44, na.rm = TRUE),  # Count of individuals aged 40-44
        nbrAge_45_49 = sum(B08 >= 45 & B08 <= 49, na.rm = TRUE),  # Count of individuals aged 45-49
        nbrAge_50_54 = sum(B08 >= 50 & B08 <= 54, na.rm = TRUE),  # Count of individuals aged 50-54
        nbrAge_55_59 = sum(B08 >= 55 & B08 <= 59, na.rm = TRUE),  # Count of individuals aged 55-59
        nbrAge_60_64 = sum(B08 >= 60 & B08 <= 64, na.rm = TRUE),  # Count of individuals aged 60-64
        nbrAge_65_69 = sum(B08 >= 65 & B08 <= 69, na.rm = TRUE),  # Count of individuals aged 65-69
        nbrAge_70_74 = sum(B08 >= 70 & B08 <= 74, na.rm = TRUE),  # Count of individuals aged 70-74
        nbrAge_75_79 = sum(B08 >= 75 & B08 <= 79, na.rm = TRUE),  # Count of individuals aged 75-79
        nbrAge_80_over = sum(B08 >= 80, na.rm = TRUE)  # Count of individuals aged more than 80
) %>% 
  ungroup() %>% 
  pivot_longer(cols = nbrAge_0_14:nbrAge_80_over, names_to = "Age_group", values_to = "count")

```


```{r}
# Modify the existing dataPop_graph_2002 dataframe
dataPop_graph_2002 <- dataPop_graph_2002 %>% 
  mutate(
    # Survey year
    RGPH="2002",
    # Convert QB04 to a factor variable
    QB04 = as.factor(QB04),
    # Recode QB04 to represent Male and Female
    QB04 = recode(QB04, "1"="Male", "2"="Female"),
    
    # Recode Age_group for better readability
    Age_group = recode(Age_group,
                       "nbrAge_0_14"="0 to 14",
                       "nbrAge_15_19"="15 to 19",
                       "nbrAge_20_24"="20 to 24",
                       "nbrAge_25_29"="25 to 29",
                       "nbrAge_30_34"="30 to 34",
                       "nbrAge_35_39"="35 to 39",
                       "nbrAge_40_44"="40 to 44",
                       "nbrAge_45_49"="45 to 49",
                       "nbrAge_50_54"="50 to 54",
                       "nbrAge_55_59"="55 to 59",
                       "nbrAge_60_64"="60 to 64",
                       "nbrAge_65_69"="65 to 69",
                       "nbrAge_70_74"="70 to 74",
                       "nbrAge_75_79"="75 to 79",
                       "nbrAge_80_over"="80 and over"),
    
    # Adjust count based on gender
    count = ifelse(QB04 == "Male", -count, count),
    # Normalize count by total number of individuals
    count = count/n
  ) %>% 
  rename("Sexe"="QB04")

# Modify the existing dataPop_graph_2013 dataframe
dataPop_graph_2013 <- dataPop_graph_2013 %>% 
  mutate(
     # Survey year
    RGPH="2013",
    # Convert B06 to a factor variable
    B06 = as.factor(B06),
    # Recode B06 to represent Male and Female
    B06 = recode(B06, "1"="Male", "2"="Female"),
    
    # Recode Age_group for better readability
    Age_group = recode(Age_group,
                       "nbrAge_0_14"="0 to 14",
                       "nbrAge_15_19"="15 to 19",
                       "nbrAge_20_24"="20 to 24",
                       "nbrAge_25_29"="25 to 29",
                       "nbrAge_30_34"="30 to 34",
                       "nbrAge_35_39"="35 to 39",
                       "nbrAge_40_44"="40 to 44",
                       "nbrAge_45_49"="45 to 49",
                       "nbrAge_50_54"="50 to 54",
                       "nbrAge_55_59"="55 to 59",
                       "nbrAge_60_64"="60 to 64",
                       "nbrAge_65_69"="65 to 69",
                       "nbrAge_70_74"="70 to 74",
                       "nbrAge_75_79"="75 to 79",
                       "nbrAge_80_over"="80 and over"),
    
    # Adjust count based on gender
    count = ifelse(B06 == "Male", -count, count),
    # Normalize count by total number of individuals
    count = count/n
  ) %>% 
  rename("Sexe"="B06")
```



```{r}
# Create a bar plot using ggplot with data from dataPop_graph_2002
ggplot(dataPop_graph_2002, 
       aes(x = count, 
           y = Age_group, 
           fill = Sexe)) + 
  # Use geom_col to create a column chart with specified width and transparency
  geom_col(width = 0.95, alpha = 0.75) + 
  
  # Set the theme to minimal with specified font family and size
  theme_minimal(base_family = "Verdana", 
                base_size = 12) + 
  
  # Customize the x-axis labels to show percentages and limit the range
  scale_x_continuous(
    labels = ~ scales::number_format(scale = 100, suffix = "")(abs(.x)),
    limits = 0.4 * c(-1,1)
  ) + 
  
  # Manually set fill colors for Male and Female
  scale_fill_manual(values = c("darkblue", "darkgoldenrod1")) + 
  
  # Customize labels and title
  labs(x = "percent (%)", 
       y = " ", 
       title = "Population structure in Guediawaye in 2002 ", 
       fill = "", 
       caption = "")

# Save the plot as an image file in the specified directory
ggsave(paste0(here::here(),"/output/output_img/pyramide_2002.png"), width = 8, height = 5)
```


```{r}
# Create a bar plot using ggplot with data from dataPop_graph_2013
ggplot(dataPop_graph_2013, 
       aes(x = count, 
           y = Age_group, 
           fill = Sexe)) + 
  # Use geom_col to create a column chart with specified width and transparency
  geom_col(width = 0.95, alpha = 0.75) + 
  
  # Set the theme to minimal with specified font family and size
  theme_minimal(base_family = "Verdana", 
                base_size = 12) + 
  
  # Customize the x-axis labels to show percentages and limit the range
  scale_x_continuous(
    labels = ~ scales::number_format(scale = 100, suffix = "")(abs(.x)),
    limits = 0.4 * c(-1,1)
  ) + 
  
  # Manually set fill colors for Male and Female
  scale_fill_manual(values = c("darkblue", "darkgoldenrod1")) + 
  
  # Customize labels and title
  labs(x = "percent (%)", 
       y = " ", 
       title = "Population structure in Guediawaye in 2013 ", 
       fill = "", 
       caption = "")

# Save the plot as an image file in the specified directory
ggsave(paste0(here::here(),"/output/output_img/pyramide_2013.png"), width = 8, height = 5)
```

```{r}
# Combine two data frames using rbind.fill from the plyr package
dataPop_graph_2013 %>%
  plyr::rbind.fill(dataPop_graph_2002) %>%
  
  # Create a ggplot object
  ggplot() +
  
  # Create a column plot with specified aesthetics
  geom_col(aes(
    fill = interaction(Sexe, RGPH, sep = " in "),
    x = Age_group,
    y = count
  ), position = "dodge") +
  
  # Customize the y-axis labels as percentages
  scale_y_continuous(labels = ~ scales::number_format(scale = 100)(abs(.x)),
                     expand = c(0, 0)) +
  
  # Set manual fill colors for the plot
  scale_fill_manual(values = c("lightblue1", "lightblue4", "lightgoldenrod1", "lightgoldenrod4"),
                    name = "") +
  
  # Flip the coordinates to create a horizontal bar chart
  coord_flip() +
  
  # Create facets based on the variable 'Sexe'
  facet_wrap(~ Sexe,
             scale = "free_x",
             strip.position = "top") +
  
  # Customize plot labels and title
  labs(x = "",
       y = "percent (%)",
       title = "Population structure in Guediawaye by sex",
       caption = "") +
  
  # Apply a minimal theme to the plot
  theme_minimal() +
  
  # Customize additional theme elements
  theme(
    strip.background = element_blank(),
    legend.position = "bottom",
    panel.spacing.x = unit(0, "pt")
  )
# Save the plot as an image file in the specified directory
ggsave(paste0(here::here(),"/output/output_img/pyramide_all.png"), width = 8, height = 5)
```




```{r, echo=FALSE, warning=FALSE, include=FALSE}
## Removing all objects
rm(list=ls())
```
